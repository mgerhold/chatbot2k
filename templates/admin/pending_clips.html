{% extends "admin/base.html" %}

{% block title %}{{ bot_name }} â€” Pending Clips{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .table-container {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.02);
        overflow: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .data-table thead th {
        background: rgba(255, 255, 255, 0.03);
        font-weight: 600;
        color: var(--text);
        position: sticky;
        top: 0;
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    .data-table tbody tr:hover {
        background: rgba(96, 165, 250, 0.05);
    }

    .data-table td.empty {
        text-align: center;
        color: var(--muted);
        padding: 2rem 1rem;
    }

    .data-table th:last-child,
    .data-table td:last-child {
        width: 1px;
        white-space: nowrap;
    }

    .data-table audio,
    .data-table video {
        max-width: 100%;
        height: auto;
        display: inline-block;
        min-height: 32px;
    }

    .data-table audio {
        min-width: 200px;
    }

    .clip-preview {
        max-height: 200px;
    }

    .edit-input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .edit-input:focus {
        outline: 2px solid var(--accent);
        outline-offset: 1px;
        background: rgba(255, 255, 255, 0.08);
    }

    .uploader-info {
        font-size: 0.875rem;
        color: var(--muted);
        margin-top: 0.25rem;
    }

    .uploader-info strong {
        color: var(--text);
    }

    .visibility-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .visibility-badge.visible {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .visibility-badge.hidden {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin: 0;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .btn-approve {
        background: #22c55e;
        color: white;
    }

    .btn-approve:hover {
        background: #16a34a;
    }

    .btn-reject {
        background: #ef4444;
        color: white;
    }

    .btn-reject:hover {
        background: #dc2626;
    }

    .duplicate-warning {
        display: none;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 4px;
        color: #ef4444;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .duplicate-warning.show {
        display: block;
    }

    /* Rejection Dialog Styles */
    .rejection-dialog-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .rejection-dialog-overlay.active {
        display: flex;
    }

    .rejection-dialog {
        background: #1a1a1a;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        min-width: 400px;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .rejection-dialog h3 {
        margin: 0 0 1rem 0;
        color: var(--text);
        font-size: 1.25rem;
    }

    .rejection-dialog-content {
        margin-bottom: 1.5rem;
    }

    .rejection-dialog-content label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text);
        font-weight: 500;
    }

    .rejection-dialog-content textarea {
        width: 100%;
        min-height: 100px;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: inherit;
        font-size: 0.95rem;
        resize: vertical;
    }

    .rejection-dialog-content textarea:focus {
        outline: 2px solid var(--accent);
        outline-offset: 1px;
        background: rgba(255, 255, 255, 0.08);
    }

    .rejection-dialog-content small {
        display: block;
        margin-top: 0.5rem;
        color: var(--muted);
        font-size: 0.85rem;
    }

    .rejection-dialog-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
    }

    .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.15);
    }
</style>
<script>
    const existingCommands = {{ existing_commands | tojson }};
    
    document.addEventListener('DOMContentLoaded', function() {
        const commandInputs = document.querySelectorAll('input[name="command_name"]');
        
        commandInputs.forEach(input => {
            const warning = document.createElement('div');
            warning.className = 'duplicate-warning';
            warning.textContent = 'Warning: A command with this name already exists!';
            input.parentElement.appendChild(warning);
            
            // Get the associated approve button
            const formId = input.getAttribute('form');
            const approveForm = document.getElementById(formId);
            const approveButton = approveForm ? approveForm.querySelector('button[type="submit"]') : null;
            
            const checkDuplicate = function() {
                const value = input.value.trim().toLowerCase().replace(/^!/, '');
                const isDuplicate = value && existingCommands.includes(value);
                
                if (isDuplicate) {
                    warning.classList.add('show');
                    if (approveButton) {
                        approveButton.disabled = true;
                        approveButton.style.opacity = '0.5';
                        approveButton.style.cursor = 'not-allowed';
                    }
                } else {
                    warning.classList.remove('show');
                    if (approveButton) {
                        approveButton.disabled = false;
                        approveButton.style.opacity = '1';
                        approveButton.style.cursor = 'pointer';
                    }
                }
            };
            
            input.addEventListener('input', checkDuplicate);
            
            // Check initial value
            checkDuplicate();
        });

        // Rejection dialog functionality
        const rejectionDialog = document.getElementById('rejectionDialog');
        const rejectionReasonInput = document.getElementById('rejectionReasonInput');
        const dialogCommandName = document.getElementById('dialogCommandName');
        const cancelRejectButton = document.getElementById('cancelRejectButton');
        const confirmRejectButton = document.getElementById('confirmRejectButton');
        
        let currentRejectForm = null;
        
        // Open dialog when reject button is clicked
        document.querySelectorAll('.reject-button').forEach(button => {
            button.addEventListener('click', function() {
                currentRejectForm = this.closest('.reject-form');
                const commandName = currentRejectForm.dataset.command;
                
                dialogCommandName.textContent = commandName;
                rejectionReasonInput.value = '';
                rejectionDialog.classList.add('active');
                
                // Focus on the textarea
                setTimeout(() => rejectionReasonInput.focus(), 100);
            });
        });
        
        // Close dialog on cancel
        cancelRejectButton.addEventListener('click', function() {
            rejectionDialog.classList.remove('active');
            currentRejectForm = null;
        });
        
        // Close dialog when clicking outside
        rejectionDialog.addEventListener('click', function(e) {
            if (e.target === rejectionDialog) {
                rejectionDialog.classList.remove('active');
                currentRejectForm = null;
            }
        });
        
        // Close dialog on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && rejectionDialog.classList.contains('active')) {
                rejectionDialog.classList.remove('active');
                currentRejectForm = null;
            }
        });
        
        // Confirm rejection
        confirmRejectButton.addEventListener('click', function() {
            if (currentRejectForm) {
                const reason = rejectionReasonInput.value.trim();
                const reasonInput = currentRejectForm.querySelector('.rejection-reason-input');
                
                // Set the rejection reason in the hidden input
                if (reason) {
                    reasonInput.value = reason;
                }
                
                // Submit the form
                currentRejectForm.submit();
            }
        });
    });
</script>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-header">
    <h1>Pending Clips</h1>
    <p>Review and approve user-submitted soundboard clips</p>
</div>

<!-- Pending Clips Table -->
<section>
    {% if pending_clips %}
    <div class="table-container" role="region" aria-labelledby="pending-clips-heading" tabindex="0">
        <h3 id="pending-clips-heading" class="sr-only">Pending Soundboard Clips</h3>
        <table class="data-table">
            <caption class="sr-only">Pending soundboard clips awaiting approval</caption>
            <thead>
            <tr>
                <th scope="col">Command</th>
                <th scope="col">Clip Preview</th>
                <th scope="col">Uploader</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for clip in pending_clips %}
            {% set lower = (clip.clip_url|lower) %}
            {% set base = lower.split('?')[0] %}
            <tr>
                <td>
                    <div>
                        <input 
                            type="text" 
                            name="command_name" 
                            value="{{ clip.command }}" 
                            class="edit-input"
                            required
                            placeholder="Command name"
                            form="approve-form-{{ clip.id }}"
                        >
                    </div>
                </td>
                <td>
                    {% if base.endswith('.mp3') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/mpeg">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.wav') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/wav">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.ogg') or base.endswith('.opus') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/ogg">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.flac') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/flac">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.aac') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/aac">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.m4a') %}
                    <audio controls preload="metadata" src="{{ clip.clip_url }}" type="audio/mp4">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.mp4') or base.endswith('.m4v') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ clip.clip_url }}" type="video/mp4">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.webm') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ clip.clip_url }}" type="video/webm">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.mov') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ clip.clip_url }}" type="video/quicktime">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.mkv') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ clip.clip_url }}" type="video/x-matroska">
                        Your browser can't play this clip. <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% else %}
                    <a href="{{ clip.clip_url }}" target="_blank" rel="noopener noreferrer">Download</a>
                    {% endif %}
                </td>
                <td>
                    <a 
                        href="https://twitch.tv/{{ clip.uploader_twitch_login }}" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        style="color: var(--accent); text-decoration: none; font-weight: 500;"
                    >
                        {{ clip.uploader_twitch_display_name }}
                    </a>
                    <br>
                    {% if clip.may_persist_uploader_info %}
                    <span class="visibility-badge visible" style="margin-top: 0.25rem; display: inline-block;">Visible after approval</span>
                    {% else %}
                    <span class="visibility-badge hidden" style="margin-top: 0.25rem; display: inline-block;">Deleted after approval</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <form 
                            id="approve-form-{{ clip.id }}"
                            method="post" 
                            action="{{ request.app.url_path_for('approve_pending_clip', clip_id=clip.id) }}"
                            style="margin: 0;"
                        >
                            <button type="submit" class="btn btn-approve">
                                Approve
                            </button>
                        </form>
                        <form 
                            method="post" 
                            action="{{ request.app.url_path_for('reject_pending_clip', clip_id=clip.id) }}"
                            style="margin: 0;"
                            class="reject-form"
                            data-clip-id="{{ clip.id }}"
                            data-command="{{ clip.command }}"
                        >
                            <input type="hidden" name="reason" class="rejection-reason-input">
                            <button type="button" class="btn btn-reject reject-button">
                                Reject
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--muted); padding: 1rem; background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 6px;">
        No pending clips at the moment. Clips submitted by viewers will appear here for review.
    </p>
    {% endif %}
</section>

<!-- Rejection Dialog -->
<div class="rejection-dialog-overlay" id="rejectionDialog">
    <div class="rejection-dialog">
        <h3>Reject Clip</h3>
        <div class="rejection-dialog-content">
            <p style="margin-bottom: 1rem; color: var(--muted);">
                Are you sure you want to reject the clip with command <strong id="dialogCommandName" style="color: var(--accent);"></strong>?
            </p>
            <label for="rejectionReasonInput">Rejection reason (optional)</label>
            <textarea 
                id="rejectionReasonInput" 
                placeholder="Enter an optional reason for rejecting this clip..."
                maxlength="500"
            ></textarea>
            <small>This message will be sent to the uploader as part of the rejection notification.</small>
        </div>
        <div class="rejection-dialog-actions">
            <button type="button" class="btn btn-cancel" id="cancelRejectButton">
                Cancel
            </button>
            <button type="button" class="btn btn-reject" id="confirmRejectButton">
                Reject
            </button>
        </div>
    </div>
</div>
{% endblock %}
