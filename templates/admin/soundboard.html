{% extends "admin/base.html" %}

{% block title %}{{ bot_name }} — Soundboard{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    .add-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(96, 165, 250, 0.05);
        border: 1px solid var(--border);
        border-radius: var(--radius);
    }

    .add-section h2 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text);
    }

    .form-group input[type="text"],
    .form-group input[type="file"] {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: inherit;
    }

    .form-group input[type="file"] {
        padding: 0.6rem 0.75rem;
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="file"]:focus {
        outline: 2px solid var(--accent);
        outline-offset: 1px;
        background: rgba(255, 255, 255, 0.08);
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: var(--muted);
        font-size: 0.875rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
        padding: 0.75rem 1.5rem;
    }

    .btn-primary:hover {
        background: var(--link-hover);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .table-container {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.02);
        overflow: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .data-table thead th {
        background: rgba(255, 255, 255, 0.03);
        font-weight: 600;
        color: var(--text);
        position: sticky;
        top: 0;
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    .data-table tbody tr:hover {
        background: rgba(96, 165, 250, 0.05);
    }

    .data-table td.empty {
        text-align: center;
        color: var(--muted);
        padding: 2rem 1rem;
    }

    .data-table th:last-child,
    .data-table td:last-child {
        width: 1px;
        white-space: nowrap;
    }

    .data-table td:nth-child(2) {
        max-width: 400px;
    }

    .data-table audio,
    .data-table video {
        max-width: 100%;
        height: auto;
        display: inline-block;
        min-height: 32px;
    }

    .data-table audio {
        min-width: 200px;
    }

    .clip-preview {
        max-height: 200px;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin: 0;
    }

    .action-buttons .btn-primary {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        background: #22c55e;
    }

    .action-buttons .btn-primary:hover {
        background: #16a34a;
    }

    .edit-input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .edit-input:focus {
        outline: 2px solid var(--accent);
        outline-offset: 1px;
        background: rgba(255, 255, 255, 0.08);
    }

    .duplicate-warning {
        display: none;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 4px;
        color: #ef4444;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .duplicate-warning.show {
        display: block;
    }
</style>
<script>
    const existingCommands = {{ existing_commands | tojson }};
    
    document.addEventListener('DOMContentLoaded', function() {
        const commandInputs = document.querySelectorAll('.data-table input[name="command_name"]');
        
        commandInputs.forEach(input => {
            const originalValueAttr = input.getAttribute('data-original-value');
            if (!originalValueAttr) {
                console.error('Missing data-original-value attribute on input:', input);
                return;
            }
            const originalValue = originalValueAttr.toLowerCase();
            const warning = document.createElement('div');
            warning.className = 'duplicate-warning';
            warning.textContent = 'Warning: A command with this name already exists!';
            input.parentElement.appendChild(warning);
            
            // Get the associated save button
            const formId = input.getAttribute('form');
            const saveForm = document.getElementById(formId);
            const saveButton = saveForm ? saveForm.querySelector('button[type="submit"]') : null;
            
            const checkDuplicate = function() {
                const value = input.value.trim().toLowerCase().replace(/^!/, '');
                // It's a duplicate only if it matches an existing command AND it's not the original value
                const isDuplicate = value && existingCommands.includes(value) && value !== originalValue;
                
                if (isDuplicate) {
                    warning.classList.add('show');
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.style.opacity = '0.5';
                        saveButton.style.cursor = 'not-allowed';
                    }
                } else {
                    warning.classList.remove('show');
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                        saveButton.style.cursor = 'pointer';
                    }
                }
            };
            
            input.addEventListener('input', checkDuplicate);
            
            // Check initial value
            checkDuplicate();
        });
        
        // Set volume on all audio/video elements based on data-volume attribute
        const mediaElements = document.querySelectorAll('audio[data-volume], video[data-volume]');
        mediaElements.forEach(element => {
            const volumeValue = parseFloat(element.getAttribute('data-volume'));
            if (!isNaN(volumeValue) && volumeValue >= 0.0 && volumeValue <= 1.0) {
                element.volume = volumeValue;
            }
        });

        // Handle volume changes and send to backend
        const volumeDebounceTimers = new Map();
        
        mediaElements.forEach(element => {
            element.addEventListener('volumechange', function() {
                const commandName = element.getAttribute('data-command');
                if (!commandName) {
                    console.error('Missing data-command attribute on media element:', element);
                    return;
                }
                
                const newVolume = element.volume;
                
                // Clear existing timer for this element
                if (volumeDebounceTimers.has(element)) {
                    clearTimeout(volumeDebounceTimers.get(element));
                }
                
                // Set new debounced timer
                const timerId = setTimeout(async () => {
                    try {
                        const response = await fetch(`/admin/soundboard/volume/${encodeURIComponent(commandName)}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ volume: newVolume }),
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            let errorMessage = 'Failed to update volume';
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = errorJson.detail || errorMessage;
                            } catch {
                                // Keep default error message
                            }
                            console.error('Failed to update volume:', errorMessage);
                        }
                    } catch (error) {
                        console.error('Error updating volume:', error);
                    } finally {
                        volumeDebounceTimers.delete(element);
                    }
                }, 500); // Debounce for 500ms
                
                volumeDebounceTimers.set(element, timerId);
            });
        });
    });
</script>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-header">
    <h1>Soundboard</h1>
    <p>Manage and preview soundboard clips</p>
</div>

<!-- Upload Form -->
<section class="add-section">
    <h2>Upload New Clip</h2>
    <form action="{{ request.app.url_path_for('upload_soundboard_clip') }}" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="command_name">Command Name</label>
            <input type="text" id="command_name" name="command_name" placeholder="e.g., mycommand" required>
            <small>Don't include the "!" prefix</small>
        </div>
        <div class="form-group">
            <label for="file">Audio/Video File</label>
            <input type="file" id="file" name="file" accept="audio/*,video/*" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload Clip</button>
    </form>
</section>

<section>
    <h2>Existing Clips</h2>
    <div class="table-container" role="region" aria-labelledby="soundboard-heading" tabindex="0">
        <h3 id="soundboard-heading" class="sr-only">Soundboard Commands</h3>
        <table class="data-table">
            <caption class="sr-only">Soundboard commands</caption>
            <thead>
            <tr>
                <th scope="col">Command</th>
                <th scope="col">Clip</th>
                <th scope="col">Uploader</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for sb in soundboard_commands %}
            {% set lower = (sb.clip_url|lower) %}
            {% set base = lower.split('?')[0] %}
            <tr>
                <td>
                    <div>
                        <input 
                            type="text" 
                            name="command_name" 
                            value="{{ sb.command }}" 
                            class="edit-input"
                            required
                            placeholder="Command name"
                            form="save-form-{{ loop.index }}"
                            data-original-value="{{ sb.command | lower }}"
                        >
                    </div>
                </td>
                <td>
                    {% if base.endswith('.mp3') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/mpeg" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.wav') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/wav" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.ogg') or base.endswith('.opus') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/ogg" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.flac') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/flac" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.aac') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/aac" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.m4a') %}
                    <audio controls preload="metadata" src="{{ sb.clip_url }}" type="audio/mp4" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </audio>
                    {% elif base.endswith('.mp4') or base.endswith('.m4v') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ sb.clip_url }}" type="video/mp4" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.webm') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ sb.clip_url }}" type="video/webm" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.mov') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ sb.clip_url }}" type="video/quicktime" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% elif base.endswith('.mkv') %}
                    <video controls preload="metadata" playsinline class="clip-preview" src="{{ sb.clip_url }}" type="video/x-matroska" data-volume="{{ sb.volume }}" data-command="{{ sb.command }}">
                        Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                    </video>
                    {% else %}
                    <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open clip</a>
                    {% endif %}
                </td>
                <td>
                    {% if sb.uploader_twitch_login and sb.uploader_twitch_display_name %}
                    <a href="https://twitch.tv/{{ sb.uploader_twitch_login }}" target="_blank" rel="noopener noreferrer">
                        {{ sb.uploader_twitch_display_name }}
                    </a>
                    {% else %}
                    <span style="color: var(--muted);">—</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <form 
                            id="save-form-{{ loop.index }}"
                            action="{{ request.app.url_path_for('update_soundboard_command', old_command_name=sb.command) }}" 
                            method="post"
                        >
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                        <form action="{{ request.app.url_path_for('delete_soundboard_clip', command_name=sb.command) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this clip?');">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="empty">No soundboard commands available.</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
