{% extends "base.html" %}
{% from "_macros.html" import avatar_header, commands_table, dictionary_table, constants_table %}

{% block title %}{{ bot_name }} Commands & Dictionary{% endblock %}

{# Enable the 3rd, 4th, and 5th tabs with the same selected styling/behavior as the others #}
{% block head_extra %}
<style>
    /* Show the Constants panel when its radio is checked */
    #tab-constants:checked ~ .tab-panels #panel-constants { display: block; }
    /* Apply the "selected" look to the Constants tab label */
    #tab-constants:checked ~ .tablist #label-constants {
      opacity: 1;
      box-shadow: 0 -1px 0 var(--accent) inset, 0 2px 12px rgba(0,0,0,0.35);
      background: linear-gradient(180deg, #101a33, #0b1322);
    }

    /* Show the Scripts panel when its radio is checked */
    #tab-scripts:checked ~ .tab-panels #panel-scripts { display: block; }
    /* Apply the "selected" look to the Scripts tab label */
    #tab-scripts:checked ~ .tablist #label-scripts {
      opacity: 1;
      box-shadow: 0 -1px 0 var(--accent) inset, 0 2px 12px rgba(0,0,0,0.35);
      background: linear-gradient(180deg, #101a33, #0b1322);
    }

    /* Show the Soundboard panel when its radio is checked */
    #tab-soundboard:checked ~ .tab-panels #panel-soundboard { display: block; }
    /* Apply the "selected" look to the Soundboard tab label */
    #tab-soundboard:checked ~ .tablist #label-soundboard {
      opacity: 1;
      box-shadow: 0 -1px 0 var(--accent) inset, 0 2px 12px rgba(0,0,0,0.35);
      background: linear-gradient(180deg, #101a33, #0b1322);
    }

    /* CodeMirror 6 styling */
    .cm-editor {
      width: 100%;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 14px;
      display: block;
      position: relative;
      contain: size layout style paint;
      /* height is set dynamically by JavaScript */
    }

    .cm-scroller {
      overflow-y: auto !important;
      overflow-x: auto !important;
      width: 100% !important;
      max-width: 100% !important;
    }

    .cm-content {
      white-space: pre !important;
      word-wrap: normal !important;
      width: max-content !important;
    }

    .cm-line {
      white-space: pre !important;
    }

    .script-editor-container {
      margin: 10px 0;
      width: 100%;
      display: block;
      position: relative;
    }

    /* Prevent table container from scrolling horizontally for scripts table */
    #panel-scripts .table-container {
      overflow-x: hidden !important;
      overflow-y: auto;
    }

    .scripts.data-table {
      table-layout: auto;
      width: 100%;
    }

    .scripts td {
      vertical-align: top;
    }

    .scripts td:first-child {
      width: 1px;
      white-space: nowrap;
    }

    .scripts .source-code-cell {
      width: 99%;
    }

    .script-data {
      display: none;
    }
    /* Soundboard table styling to prevent overflow */
    #panel-soundboard .table-container {
        overflow: auto;
    }

    #panel-soundboard .data-table {
        width: 100%;
    }

    #panel-soundboard .data-table td:nth-child(2) {
        max-width: 400px;
    }

    #panel-soundboard .data-table audio,
    #panel-soundboard .data-table video {
        max-width: 100%;
        height: auto;
        display: inline-block;
        min-height: 32px;
    }

    #panel-soundboard .data-table audio {
        min-width: 200px;
    }

    #panel-soundboard .sb-preview {
        max-height: 200px;
    }

    /* Source URL container with refresh button */
    .source-url-container {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-refresh-source {
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--accent, #4a9eff);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .btn-refresh-source:hover {
        background: rgba(74, 158, 255, 0.1);
        border-color: var(--accent, #4a9eff);
    }

    .btn-refresh-source:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-refresh-source svg {
        transition: transform 0.3s ease;
    }

    .btn-refresh-source.refreshing svg {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block header %}
{{ avatar_header(bot_name, bot_name ~ " — Overview", "All available commands and the built-in dictionary.") }}
{% endblock %}

{% block content %}
<section class="tabs" aria-label="Sections">
    <input class="tab-radio" type="radio" name="section" id="tab-commands" checked>
    <input class="tab-radio" type="radio" name="section" id="tab-constants">
    <input class="tab-radio" type="radio" name="section" id="tab-scripts">
    <input class="tab-radio" type="radio" name="section" id="tab-dictionary">
    <input class="tab-radio" type="radio" name="section" id="tab-soundboard">

    <div class="tablist" role="tablist" aria-label="Sections">
        <label class="tab" for="tab-commands" id="label-commands" role="tab"
               aria-controls="panel-commands">Commands</label>
        <label class="tab" for="tab-constants" id="label-constants" role="tab" aria-controls="panel-constants">Constants</label>
        <label class="tab" for="tab-scripts" id="label-scripts" role="tab" aria-controls="panel-scripts">Scripts</label>
        <label class="tab" for="tab-dictionary" id="label-dictionary" role="tab" aria-controls="panel-dictionary">Dictionary</label>
        <label class="tab" for="tab-soundboard" id="label-soundboard" role="tab" aria-controls="panel-soundboard">Soundboard</label>
    </div>

    <div class="tab-panels">
        <!-- Commands panel -->
        <section id="panel-commands" class="tab-panel" role="tabpanel" aria-labelledby="label-commands">
            <h2 id="commands-heading" class="sr-only">Commands</h2>
            {{ commands_table(commands) }}
        </section>

        <!-- Constants panel -->
        <section id="panel-constants" class="tab-panel" role="tabpanel" aria-labelledby="label-constants">
            <h2 id="constants-heading" class="sr-only">Constants</h2>
            {{ constants_table(constants) }}
        </section>

        <!-- Scripts panel -->
        <section id="panel-scripts" class="tab-panel" role="tabpanel" aria-labelledby="label-scripts">
            <h2 id="scripts-heading" class="sr-only">Scripts</h2>
            <div class="table-container" role="region" aria-labelledby="scripts-heading" tabindex="0">
                <table class="scripts data-table">
                    <caption class="sr-only">Script commands</caption>
                    <thead>
                    <tr>
                        <th scope="col">Command</th>
                        <th scope="col">Source Code</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for script in script_commands %}
                    <tr>
                        <td class="mono"><code>{{ script.command | e }}</code></td>
                        <td class="source-code-cell">
                            <div class="script-editor-container" data-script-command="{{ script.command | e }}"></div>
                            {% if script.source_code %}
                            <script class="script-data" type="application/json" data-command="{{ script.command | e }}">{{ script.source_code | tojson }}</script>
                            {% endif %}
                            {% if script.source_code_url %}
                            <div class="source-url-container">
                                Pulled from: <a href="{{ script.source_code_url }}" target="_blank" rel="noopener noreferrer">{{ script.source_code_url }}</a>
                                {% if is_broadcaster %}
                                <button 
                                    class="btn-refresh-source" 
                                    data-script-name="{{ script.command | e }}"
                                    title="Refresh source code from URL"
                                    aria-label="Refresh source code for {{ script.command | e }}">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                    </svg>
                                    Refresh
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="2" class="empty">No script commands available.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Dictionary panel -->
        <section id="panel-dictionary" class="tab-panel" role="tabpanel" aria-labelledby="label-dictionary">
            <h2 id="dictionary-heading" class="sr-only">Dictionary</h2>
            {{ dictionary_table(dictionary_entries) }}
        </section>

        <!-- Soundboard panel -->
        <section id="panel-soundboard" class="tab-panel" role="tabpanel" aria-labelledby="label-soundboard">
            <h2 id="soundboard-heading" class="sr-only">Soundboard</h2>
            <div class="table-container" role="region" aria-labelledby="soundboard-heading" tabindex="0">
                <table class="data-table">
                    <caption class="sr-only">Soundboard commands</caption>
                    <thead>
                    <tr>
                        <th scope="col">Command</th>
                        <th scope="col">Clip</th>
                        <th scope="col">Uploader</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for sb in soundboard_commands %}
                    {% set lower = (sb.clip_url|lower) %}
                    {% set base = lower.split('?')[0] %}
                    <tr>
                        <td class="mono"><code>{{ sb.command | e }}</code></td>
                        <td>
                            {% if base.endswith('.mp3') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/mpeg" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.wav') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/wav" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.ogg') or base.endswith('.opus') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/ogg" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.flac') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/flac" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.aac') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/aac" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.m4a') %}
                            <audio controls controlsList="novolume" preload="metadata" src="{{ sb.clip_url }}" type="audio/mp4" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </audio>
                            {% elif base.endswith('.mp4') or base.endswith('.m4v') %}
                            <video controls controlsList="novolume" preload="metadata" playsinline class="sb-preview" src="{{ sb.clip_url }}" type="video/mp4" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </video>
                            {% elif base.endswith('.webm') %}
                            <video controls controlsList="novolume" preload="metadata" playsinline class="sb-preview" src="{{ sb.clip_url }}" type="video/webm" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </video>
                            {% elif base.endswith('.mov') %}
                            <video controls controlsList="novolume" preload="metadata" playsinline class="sb-preview" src="{{ sb.clip_url }}" type="video/quicktime" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </video>
                            {% elif base.endswith('.mkv') %}
                            <video controls controlsList="novolume" preload="metadata" playsinline class="sb-preview" src="{{ sb.clip_url }}" type="video/x-matroska" data-volume="{{ sb.volume }}">
                                Your browser can't play this clip. <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open</a>.
                            </video>
                            {% else %}
                            <a href="{{ sb.clip_url }}" target="_blank" rel="noopener noreferrer">Open clip</a>
                            {% endif %}
                        </td>
                        <td>
                            {% if sb.uploader_twitch_login and sb.uploader_twitch_display_name %}
                            <a href="https://twitch.tv/{{ sb.uploader_twitch_login }}" target="_blank" rel="noopener noreferrer">
                                {{ sb.uploader_twitch_display_name }}
                            </a>
                            {% else %}
                            <span style="color: var(--muted);">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="empty">No soundboard commands available.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</section>

<!-- CodeMirror 6 -->
<script type="module">
  import { wireScriptsTab } from "/static/js/scripts_tab.bundle.js";
  document.addEventListener("DOMContentLoaded", wireScriptsTab);
</script>

<!-- Refresh source code buttons -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Set volume on all audio/video elements based on data-volume attribute
    const mediaElements = document.querySelectorAll('audio[data-volume], video[data-volume]');
    mediaElements.forEach(element => {
      const volumeValue = parseFloat(element.getAttribute('data-volume'));
      if (!isNaN(volumeValue) && volumeValue >= 0.0 && volumeValue <= 1.0) {
        element.volume = volumeValue;
      }
    });

    // Add click handlers to all refresh buttons
    document.querySelectorAll(".btn-refresh-source").forEach(button => {
      button.addEventListener("click", async (e) => {
        e.preventDefault();
        const scriptName = button.dataset.scriptName;
        
        // Disable button and add spinning animation
        button.disabled = true;
        button.classList.add("refreshing");
        
        try {
          const response = await fetch(`/api/refresh-source-code/${encodeURIComponent(scriptName)}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          });
          
          if (response.ok) {
            // Success - reload the page to show updated source code
            window.location.reload();
          } else {
            // Handle error
            const errorText = await response.text();
            let errorMessage = "Failed to refresh source code";
            try {
              const errorJson = JSON.parse(errorText);
              errorMessage = errorJson.detail || errorMessage;
            } catch {
              // Keep default error message
            }
            alert(errorMessage);
            button.disabled = false;
            button.classList.remove("refreshing");
          }
        } catch (error) {
          console.error("Error refreshing source code:", error);
          alert("Network error while refreshing source code");
          button.disabled = false;
          button.classList.remove("refreshing");
        }
      });
    });
  });
</script>
{% endblock %}
